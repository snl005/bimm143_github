---
title: "Class 14: RNASeq mini Project"
author: "Le, Sarah (PID: A18518276)"
format: pdf
toc: true
---

## Background

Here we work through a complete RNASeq analysis project. The input data comes from a knock-down experiment of a HOX gene.

## Data Import

Reading the counts and metadata CSV files

```{r}
countData <- read.csv("GSE37704_featurecounts.csv",row.names = 1)
metadata <- read.csv("GSE37704_metadata.csv")
```

```{r}
head(countData)
```

```{r}
head(metadata)
```

> Q1. Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).

```{r}
# Note we need to remove the odd first $length col
countData <- as.matrix(countData[,-1])
head(countData)
```

> Q2. Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).

```{r}
# Filter count data where you have 0 read count across all samples.
countData = countData[rowSums(countData)>0, ]
head(countData)
```

Some book-keeping is required as there looks to be a mis-match between metadata rows and counts columns.

```{r}
ncol(countData)
```

```{r}
nrow(metadata)
```

We need to remove the first column for count.

```{r}
cleancounts <- countData[,-1]
head(cleancounts)
```

```{r}
all(colnames(cleancounts) == metadata$id)
```

## Remove zero count genes

There are lost of genes with zero counts. We can remove these from further analysis.

```{r}
head(cleancounts)
```

```{r}
to.keep.inds <- rowSums(cleancounts) >0
nonzero_counts <- cleancounts[to.keep.inds,]
```

## DESeq Analysis

Load the package.

```{r, message=FALSE}
library(DESeq2)
```

Setup DESeq.

```{r}
dds = DESeqDataSetFromMatrix(countData=countData,
                             colData=metadata,
                             design=~condition)
```

Run DESeq.

```{r}
dds <- DESeq(dds)
dds
```

Get results.

```{r}
res = results(dds, contrast=c("condition", "hoxa1_kd", "control_sirna"))
```

> Q3. Call the summary() function on your results to get a sense of how many genes are up or down-regulated at the default 0.1 p-value cutoff.

```{r}
summary(res)
```

## Data Visualization

Volcano plot.
```{r}
plot( res$log2FoldChange, -log(res$padj) )
```

```{r}
library(ggplot2)

ggplot(res) +
  aes(log2FoldChange, -log(padj),
      color = abs(log2FoldChange) > 2 & abs(-log(padj)) > 0.05) +
  geom_point() +
  scale_color_manual(values = c("blue", "grey")) +
  geom_vline(xintercept = c (-2,2), col="red") +
  geom_hline(yintercept = -log(0.05), col="red")
```

Add threshold lines for fold-change and p-value and color our subset of genes that make these threshold cut-offs in the plot.

> Q4. Improve this plot by completing the below code, which adds color and axis labels

```{r}
# Make a color vector for all genes
mycols <- rep("gray", nrow(res) )

# Color red the genes with absolute fold change above 2
mycols[ abs(res$log2FoldChange) > 2 ] <- "red"

# Color blue those with adjusted p-value less than 0.01
#  and absolute fold change more than 2
inds <- (res$padj <0.01) & (abs(res$log2FoldChange) > 2 )
mycols[ inds ] <- "blue"

plot( res$log2FoldChange, -log(res$padj), col= mycols, xlab="Log2(FoldChange)", ylab="-Log(P-value)" )
```


## Add annotation

Add gene symbols and entrez ids.

> Q5. Use the mapIDs() function multiple times to add SYMBOL, ENTREZID and GENENAME annotation to our results by completing the code below.

```{r}
library("AnnotationDbi")
library("org.Hs.eg.db")
```

```{r}
res$symbol <- mapIds(x=org.Hs.eg.db,
                     keys = row.names(res),
                     keytype = "ENSEMBL",
                     column = "SYMBOL",
                     multiVals="first")
```

```{r}
res$entrez <- mapIds(x=org.Hs.eg.db,
                     keys = row.names(res),
                     keytype = "ENSEMBL",
                     column = "ENTREZID",
                     multiVals="first")
```

```{r}
res$name =   mapIds(org.Hs.eg.db,
                    keys=row.names(res),
                    keytype= "ENSEMBL",
                    column= "GENENAME",
                    multiVals="first")
```

```{r}
head(res, 10)
```

> Q6. Finally for this section let's reorder these results by adjusted p-value and save them to a CSV file in your current project directory.

```{r}
res = res[order(res$pvalue),]
write.csv(res, file="deseq_results.csv")
```

## Pathway Analysis

## KEGG Pathways

Run gage analysis with KEGG.

```{r, message= FALSE}
library(gage)
library(gageData)
library(pathview)
```

```{r}
data(kegg.sets.hs)
data(sigmet.idx.hs)

# Focus on signaling and metabolic pathways only
kegg.sets.hs = kegg.sets.hs[sigmet.idx.hs]

# Examine the first 3 pathways
head(kegg.sets.hs, 3)
```

We need a named vector of fold-change values as input for gage.

```{r}
foldchanges = res$log2FoldChange
names(foldchanges) = res$entrez
head(foldchanges)
```

```{r}
keggres = gage(foldchanges, gsets=kegg.sets.hs)
```

```{r}
pathview(pathway.id = "hsa04110", gene.data = foldchanges)
```

![](hsa04110.pathview.png)

```{r}
# A different PDF based output of the same data
pathview(gene.data=foldchanges, pathway.id="hsa04110", kegg.native=FALSE)
```

```{r}
## Focus on top 5 upregulated pathways here for demo purposes only
keggrespathways <- rownames(keggres$greater)[1:5]

# Extract the 8 character long IDs part of each string
keggresids = substr(keggrespathways, start=1, stop=8)
keggresids
```

```{r}
pathview(gene.data=foldchanges, pathway.id=keggresids, species="hsa")
```

![](hsa00140.pathview.png)

![](hsa04630.pathview.png)

![](hsa04142.pathview.png)

![](hsa04640.pathview.png)

![](hsa04330.pathview.png)

> Q7. Can you do the same procedure as above to plot the pathview figures for the top 5 down-reguled pathways?

```{r}
# Get top 5 DOWN-regulated pathways
keggrespathways_down <- rownames(keggres$less)[1:5]

# Extract only the KEGG ID part (first 8 characters)
keggresids_down <- substr(keggrespathways_down, start = 1, stop = 8)

keggresids_down
```

```{r}
pathview(gene.data = foldchanges,
         pathway.id = keggresids_down,
         species = "hsa")
```

![](hsa04110.pathview.png)

![](hsa03030.pathview.png)

![](hsa03013.pathview.png)

![](hsa03440.pathview.png)

![](hsa04114.pathview.png)

## GO terms

Same analysis but using GO terms rather than KEGG.

```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focus on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]
gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)
```

```{r}
head(gobpres$less, 4)
```

## Reactome

Lots of folks like the reactome web interface. You can also run this as an R function but lets look at the website first. < https://reactome.org/>

The website wants a text file with one gene symbol per line of the genes you want to map to pathways.

```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj),] $symbol
head(sig_genes)
```

```{r}
print(paste("Total number of significant genes:", length(sig_genes)))
```

And write out to a file.

```{r}
write.table (sig_genes, file= "significant_genes.txt", row.names= FALSE, col.names=FALSE, quote=FALSE)
```

> Q8. What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

The most significant pathway is Cell Cycle (lowest entities p-value of 2.65x10^-5). KEGG did not have the exact same pathway but they both analyze cell cycle biology. The factors that could cause the differences between the two methods are that they use different pathway definitions, gene annotations and statistical methods. Reactome uses hierarchical pathway structures with uses only significant genes while KEGG uses broader metabolic and signaling categories with fold-change values. 

## Save our results

```{r}
write.csv(res, file = "myresults.csv")
```

